name: Deploy MCP SSE

# Deploys the SSE container to Railway after a successful Release workflow.
# Requires RAILWAY_TOKEN secret and DEPLOY_TARGET=railway variable.
# Optional: RAILWAY_SERVICE variable to specify the service name.

on:
  workflow_run:
    workflows: ["Release"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >-
      ${{
        vars.DEPLOY_TARGET == 'railway' &&
        (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success')
      }}
    steps:
      - uses: actions/checkout@v6

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE: ${{ vars.RAILWAY_SERVICE }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "::warning::RAILWAY_TOKEN not set â€” skipping Railway deploy"
            exit 0
          fi
          if [ -n "$RAILWAY_SERVICE" ]; then
            railway up --service "$RAILWAY_SERVICE" --detach
          else
            railway up --detach
          fi
