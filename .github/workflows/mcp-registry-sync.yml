name: MCP Registry Sync

on:
  schedule:
    - cron: "0 9 * * 1"   # Every Monday at 09:00 UTC
  workflow_dispatch:        # Also triggerable manually from the Actions tab

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    name: Check MCP server registry for new entries
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.11"

      - name: Fetch official MCP server list
        id: fetch
        run: |
          python - <<'EOF'
          import json
          import urllib.request
          import sys
          from pathlib import Path

          REGISTRY_URL = "https://raw.githubusercontent.com/modelcontextprotocol/servers/main/scripts/servers.json"
          REGISTRY_PATH = Path("src/agent_bom/mcp_registry.json")

          # Load existing registry
          existing = json.loads(REGISTRY_PATH.read_text())
          known_packages = set(existing["servers"].keys())

          # Fetch upstream
          try:
              with urllib.request.urlopen(REGISTRY_URL, timeout=30) as resp:
                  upstream = json.loads(resp.read())
          except Exception as e:
              print(f"Could not fetch upstream registry: {e}", file=sys.stderr)
              # Not a fatal error â€” write 0 new servers and exit cleanly
              Path("/tmp/new_count").write_text("0")
              sys.exit(0)

          new_servers = {}
          for entry in upstream if isinstance(upstream, list) else upstream.get("servers", []):
              if isinstance(entry, dict):
                  name = entry.get("package") or entry.get("name", "")
                  ecosystem = "npm" if name.startswith("@") or "-" in name else "pypi"
                  if name and name not in known_packages:
                      new_servers[name] = {
                          "ecosystem": ecosystem,
                          "package": name,
                          "description": entry.get("description", ""),
                          "command_patterns": [name.split("/")[-1]],
                          "category": entry.get("category", "uncategorized"),
                      }

          if new_servers:
              existing["servers"].update(new_servers)
              from datetime import datetime, timezone
              existing["_updated"] = datetime.now(timezone.utc).strftime("%Y-%m-%d")
              REGISTRY_PATH.write_text(json.dumps(existing, indent=2) + "\n")
              print(f"Added {len(new_servers)} new server(s): {', '.join(new_servers.keys())}")

          Path("/tmp/new_count").write_text(str(len(new_servers)))
          EOF

      - name: Read new server count
        id: count
        run: echo "new_count=$(cat /tmp/new_count)" >> "$GITHUB_OUTPUT"

      - name: Create PR if registry changed
        if: steps.count.outputs.new_count != '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH="chore/mcp-registry-$(date +%Y%m%d)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add src/agent_bom/mcp_registry.json
          git commit -m "chore: sync MCP registry â€” ${{ steps.count.outputs.new_count }} new server(s)"
          git push origin "$BRANCH"
          gh pr create \
            --title "chore: MCP registry sync â€” ${{ steps.count.outputs.new_count }} new server(s)" \
            --body "Automated weekly sync from the official MCP server registry.

          **New servers added:** ${{ steps.count.outputs.new_count }}

          Please review the new entries in \`src/agent_bom/mcp_registry.json\` before merging.
          Each entry should have a correct \`ecosystem\`, \`category\`, and \`command_patterns\`.

          ðŸ¤– Generated by [mcp-registry-sync.yml](.github/workflows/mcp-registry-sync.yml)" \
            --label "dependencies" \
            --base main

      - name: No changes
        if: steps.count.outputs.new_count == '0'
        run: echo "MCP registry is up to date â€” no new servers found."
