name: MCP Registry Sync

on:
  schedule:
    - cron: "0 9 * * 1"   # Every Monday at 09:00 UTC
  workflow_dispatch:        # Also triggerable manually from the Actions tab

permissions:
  contents: read

jobs:
  sync:
    name: Sync MCP registry (new servers + version refresh)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Install httpx for version lookups
        run: pip install httpx

      - name: Fetch official MCP server list
        id: fetch
        run: |
          python - <<'EOF'
          import json
          import urllib.request
          import sys
          from pathlib import Path

          REGISTRY_URL = "https://raw.githubusercontent.com/modelcontextprotocol/servers/main/scripts/servers.json"
          REGISTRY_PATH = Path("src/agent_bom/mcp_registry.json")

          # Load existing registry
          existing = json.loads(REGISTRY_PATH.read_text())
          known_packages = set(existing["servers"].keys())

          # Fetch upstream
          try:
              with urllib.request.urlopen(REGISTRY_URL, timeout=30) as resp:
                  upstream = json.loads(resp.read())
          except Exception as e:
              print(f"Could not fetch upstream registry: {e}", file=sys.stderr)
              # Not a fatal error — write 0 new servers and exit cleanly
              Path("/tmp/new_count").write_text("0")
              sys.exit(0)

          new_servers = {}
          for entry in upstream if isinstance(upstream, list) else upstream.get("servers", []):
              if isinstance(entry, dict):
                  name = entry.get("package") or entry.get("name", "")
                  ecosystem = "npm" if name.startswith("@") or "-" in name else "pypi"
                  if name and name not in known_packages:
                      new_servers[name] = {
                          "ecosystem": ecosystem,
                          "package": name,
                          "description": entry.get("description", ""),
                          "command_patterns": [name.split("/")[-1]],
                          "category": entry.get("category", "uncategorized"),
                      }

          if new_servers:
              existing["servers"].update(new_servers)
              from datetime import datetime, timezone
              existing["_updated"] = datetime.now(timezone.utc).strftime("%Y-%m-%d")
              REGISTRY_PATH.write_text(json.dumps(existing, indent=2) + "\n")
              print(f"Added {len(new_servers)} new server(s): {', '.join(new_servers.keys())}")

          Path("/tmp/new_count").write_text(str(len(new_servers)))
          EOF

      - name: Refresh registry versions from npm/PyPI
        id: refresh
        run: |
          python - <<'EOF'
          import asyncio, json, httpx
          from pathlib import Path

          REGISTRY_PATH = Path("src/agent_bom/mcp_registry.json")
          NPM = "https://registry.npmjs.org"
          PYPI = "https://pypi.org/pypi"

          async def fetch_version(client, pkg, ecosystem):
              try:
                  if ecosystem == "npm":
                      encoded = pkg.replace("/", "%2F")
                      r = await client.get(f"{NPM}/{encoded}/latest", timeout=10)
                      if r.status_code == 200:
                          return r.json().get("version")
                  elif ecosystem == "pypi":
                      r = await client.get(f"{PYPI}/{pkg}/json", timeout=10)
                      if r.status_code == 200:
                          return r.json().get("info", {}).get("version")
              except Exception:
                  pass
              return None

          async def main():
              data = json.loads(REGISTRY_PATH.read_text())
              sem, updated = asyncio.Semaphore(5), 0

              async def update_one(client, entry):
                  nonlocal updated
                  async with sem:
                      v = await fetch_version(client, entry["package"], entry["ecosystem"])
                      if v and v != entry.get("latest_version"):
                          entry["latest_version"] = v
                          updated += 1

              async with httpx.AsyncClient() as client:
                  tasks = [update_one(client, e) for e in data["servers"].values()]
                  await asyncio.gather(*tasks)

              if updated:
                  from datetime import datetime, timezone
                  data["_updated"] = datetime.now(timezone.utc).strftime("%Y-%m-%d")
                  REGISTRY_PATH.write_text(json.dumps(data, indent=2) + "\n")
                  print(f"Refreshed {updated} package version(s)")

              Path("/tmp/version_count").write_text(str(updated))

          asyncio.run(main())
          EOF

      - name: Read counts
        id: count
        run: |
          echo "new_count=$(cat /tmp/new_count)" >> "$GITHUB_OUTPUT"
          echo "version_count=$(cat /tmp/version_count 2>/dev/null || echo 0)" >> "$GITHUB_OUTPUT"

      - name: Create PR if registry changed
        if: steps.count.outputs.new_count != '0' || steps.count.outputs.version_count != '0'
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_COUNT: ${{ steps.count.outputs.new_count }}
          VERSION_COUNT: ${{ steps.count.outputs.version_count }}
        run: |
          BRANCH="chore/mcp-registry-$(date +%Y%m%d)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add src/agent_bom/mcp_registry.json
          git commit -m "chore: sync MCP registry — ${NEW_COUNT} new server(s), ${VERSION_COUNT} version update(s)"
          git push origin "$BRANCH"
          gh pr create \
            --title "chore: MCP registry sync — ${NEW_COUNT} new, ${VERSION_COUNT} version updates" \
            --body "Automated weekly sync from the official MCP server registry.

          **New servers added:** ${NEW_COUNT}
          **Versions refreshed:** ${VERSION_COUNT}

          Please review the changes in \`src/agent_bom/mcp_registry.json\` before merging." \
            --base main

      - name: No changes
        if: steps.count.outputs.new_count == '0' && steps.count.outputs.version_count == '0'
        run: echo "MCP registry is up to date — no new servers or version changes found."
