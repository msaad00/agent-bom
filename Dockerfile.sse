# MCP Server — Streamable HTTP transport for remote clients.
#
# Exposes agent-bom's 14 MCP tools over streamable HTTP so that Smithery, Claude
# Desktop (remote mode), and any other MCP client can connect via public URL.
#
# Build:   docker build -f Dockerfile.sse -t agent-bom-sse .
# Run:     docker run -p 8423:8423 agent-bom-sse
# Test:    curl http://localhost:8423/mcp
#
# Environment variables (optional):
#   NVD_API_KEY  — Higher rate limits for CVSS enrichment
#   PORT         — Override default port (Railway/Render inject this)

FROM python:3.12-slim@sha256:39e4e1ccb01578e3c86f7a0cf7b7fd89b8dbe2c27a88de11cf726ba669469f49

ARG VERSION=0.36.1

LABEL org.opencontainers.image.title="agent-bom MCP Server"
LABEL org.opencontainers.image.description="AI supply chain security scanner — MCP server with streamable HTTP transport"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.source="https://github.com/msaad00/agent-bom"
LABEL org.opencontainers.image.licenses="Apache-2.0"
LABEL io.modelcontextprotocol.server.name="io.github.msaad00/agent-bom"
LABEL io.modelcontextprotocol.server.transport="streamable-http"

WORKDIR /app

# Install dependencies first for better layer caching
COPY pyproject.toml README.md LICENSE ./
COPY src/ ./src/

RUN pip install --no-cache-dir ".[mcp-server]"

# Create non-root user for least-privilege execution
RUN addgroup --system abom && adduser --system --ingroup abom abom
USER abom

# Streamable HTTP transport defaults
ENV PYTHONUNBUFFERED=1
ENV PORT=8423

EXPOSE ${PORT}

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD agent-bom --version || exit 1

# Use shell form so $PORT is expanded at runtime (Railway/Render inject PORT)
CMD agent-bom mcp-server --transport streamable-http --host 0.0.0.0 --port ${PORT}
